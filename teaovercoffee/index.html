<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #f8f9fa;
      --bg-card: #ffffff;
      --bg-dark: #1a1d21;
      --text-primary: #1a1d21;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --border: #e8eaed;
      --accent: #2563eb;
      --accent-light: #dbeafe;
      --success: #10b981;
      --success-light: #d1fae5;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    header {
      background: var(--bg-dark);
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }

    header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 12px;
    }

    header h1 span { color: var(--accent); }

    nav { display: flex; gap: 6px; flex-wrap: wrap; }

    nav button {
      flex: 1;
      min-width: 70px;
      padding: 10px 12px;
      border: none;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    nav button:hover { background: rgba(255,255,255,0.15); }
    nav button.active { background: var(--accent); color: white; }

    main {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 100px;
    }

    .page { display: none; animation: fadeIn 0.3s ease; }
    .page.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .section-header h2 { font-size: 1.5rem; font-weight: 700; }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body { padding: 20px; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full-width { grid-column: 1 / -1; }

    label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }

    input, select, textarea {
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: var(--bg-card);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    input[type="number"] { -moz-appearance: textfield; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #059669; }
    .btn-sm { padding: 8px 12px; font-size: 0.8125rem; }
    .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; }

    .table-wrapper { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }

    table { width: 100%; border-collapse: collapse; min-width: 500px; }

    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }

    th {
      background: var(--bg-primary);
      font-weight: 600;
      font-size: 0.8125rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    tbody tr:hover { background: var(--bg-primary); }
    tbody tr.has-balance { background: var(--danger-light); }
    tbody tr.is-cleared { opacity: 0.5; background: var(--success-light); }

    .mobile-cards { display: none; }

    @media (max-width: 768px) {
      .table-wrapper { display: none; }
      .mobile-cards { display: flex; flex-direction: column; gap: 12px; }
    }

    .entry-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
    }

    .entry-card.has-balance { border-left: 4px solid var(--danger); background: var(--danger-light); }
    .entry-card.is-cleared { border-left: 4px solid var(--success); background: var(--success-light); opacity: 0.7; }

    .entry-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .entry-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .entry-card-field label { display: block; font-size: 0.75rem; margin-bottom: 4px; }
    .entry-card-field input, .entry-card-field select { width: 100%; padding: 10px 12px; }

    .entry-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .entry-card-balance { font-size: 1.25rem; font-weight: 700; }
    .entry-card-balance.positive { color: var(--danger); }
    .entry-card-balance.zero { color: var(--success); }

    .status { font-size: 1.25rem; }

    .date-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      background: var(--bg-card);
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .date-row label { font-weight: 600; color: var(--text-primary); }
    .date-row input[type="date"] { flex: 1; min-width: 150px; max-width: 200px; }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .report-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .report-card-label { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px; }
    .report-card-value { font-size: 1.5rem; font-weight: 700; }
    .report-card-value.positive { color: var(--danger); }
    .report-card-value.negative { color: var(--success); }

    .report-card.highlight { background: var(--accent); color: white; border-color: var(--accent); }
    .report-card.highlight .report-card-label { color: rgba(255,255,255,0.8); }

    .report-card.success { background: var(--success); color: white; border-color: var(--success); }
    .report-card.success .report-card-label { color: rgba(255,255,255,0.8); }

    .report-divider { grid-column: 1 / -1; height: 1px; background: var(--border); margin: 8px 0; }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 { font-size: 1.25rem; font-weight: 700; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end; }

    .config-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--bg-dark);
      color: white;
      border: none;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      font-size: 1.5rem;
      z-index: 50;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
    }

    .connection-status.connected { background: var(--success-light); color: var(--success); }
    .connection-status.disconnected { background: var(--danger-light); color: var(--danger); }
    .connection-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-muted); }

    .spinner {
      width: 24px; height: 24px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 12px; }

    input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent); }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-dark);
      color: white;
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      z-index: 300;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    .action-bar { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }

    .delete-btn {
      color: var(--danger);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      font-size: 1.25rem;
      opacity: 0.6;
    }

    .delete-btn:hover { opacity: 1; }

    .serial-badge {
      display: inline-block;
      background: var(--accent-light);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .loan-type-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .loan-type-badge.given { background: var(--success-light); color: var(--success); }
    .loan-type-badge.received { background: var(--warning-light); color: var(--warning); }

    .info-box {
      background: var(--accent-light);
      border: 1px solid var(--accent);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 20px;
      font-size: 0.875rem;
      color: var(--accent);
    }

    .amount-display { font-weight: 600; color: var(--text-primary); }

    @media (max-width: 480px) {
      header h1 { font-size: 1.125rem; }
      nav button { padding: 8px 10px; font-size: 0.75rem; }
      main { padding: 16px; }
      .section-header h2 { font-size: 1.25rem; }
      .form-grid { grid-template-columns: 1fr; }
      .report-card-value { font-size: 1.25rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Account <span>Manager</span></h1>
    <nav>
      <button data-page="entries" class="active">Entries</button>
      <button data-page="loan">Loan</button>
      <button data-page="token">Token</button>
      <button data-page="reports">Reports</button>
    </nav>
  </header>

  <main>
    <!-- Combined Entries + Customers Section -->
    <section id="entries" class="page active">
      <div class="section-header">
        <h2>Daily Entries</h2>
      </div>

      <div id="connection-status" class="connection-status disconnected">
        <span class="connection-dot"></span>
        <span>Not connected to Airtable</span>
      </div>

      <div class="date-row">
        <label>üìÖ Date:</label>
        <input type="date" id="entry-date">
        <button id="load-entries" class="btn btn-primary">Load</button>
      </div>

      <!-- Entries Table -->
      <div class="card">
        <div class="card-header">üìù Entries for <span id="entries-date-label">Today</span> (<span id="entry-count">0</span>)</div>
        <div id="entries-loading" class="loading" style="display: none;">
          <div class="spinner"></div>
          Loading...
        </div>
        <div id="entries-empty" class="empty-state" style="display: none;">
          <div class="empty-state-icon">üìù</div>
          <p>No customers for this date. Add below.</p>
        </div>
        <div class="table-wrapper">
          <table id="entries-table">
            <thead>
              <tr>
                <th>Serial</th>
                <th>Customer</th>
                <th>To Pay</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Clear</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="entries-mobile-cards" class="mobile-cards" style="padding: 16px;"></div>
      </div>

      <div class="action-bar">
        <button id="save-entries" class="btn btn-success">üíæ Save</button>
        <span id="auto-save-status" style="color: var(--text-muted); font-size: 0.875rem; display: flex; align-items: center; gap: 6px;"></span>
      </div>

      <!-- Add Customer Form -->
      <div class="card" style="margin-top: 24px;">
        <div class="card-header">‚ûï Add New Customer</div>
        <div class="card-body">
          <form id="customer-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="customerName">Customer Name *</label>
                <input type="text" id="customerName" name="name" placeholder="Full name" required>
              </div>
              <div class="form-group">
                <label for="amountToPay">Amount to Pay *</label>
                <input type="number" id="amountToPay" name="amountToPay" placeholder="0.00" min="0" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="agentCode">Agent Code</label>
                <input type="text" id="agentCode" name="agentCode" placeholder="e.g. AG01">
              </div>
              <div class="form-group">
                <label for="bank">Bank</label>
                <select id="bank" name="bank">
                  <option value="">Select Bank</option>
                </select>
              </div>
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Add Customer</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Loan Section -->
    <section id="loan" class="page">
      <div class="section-header">
        <h2>Loan Management</h2>
      </div>

      <div class="date-row">
        <label>üìÖ Date:</label>
        <input type="date" id="loan-date">
        <button id="load-loans" class="btn btn-primary">Load</button>
      </div>

      <!-- Add Loan Form -->
      <div class="card">
        <div class="card-header">‚ûï Add Loan Entry</div>
        <div class="card-body">
          <form id="loan-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="loanType">Type *</label>
                <select id="loanType" name="type" required>
                  <option value="Given">Loan Given (They owe us)</option>
                  <option value="Received">Loan Received (We owe them)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="loanCustomerName">Customer Name *</label>
                <input type="text" id="loanCustomerName" name="name" placeholder="Full name" required>
              </div>
              <div class="form-group">
                <label for="loanAmount">Amount *</label>
                <input type="number" id="loanAmount" name="amount" placeholder="0.00" min="0" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="loanNotes">Notes</label>
                <input type="text" id="loanNotes" name="notes" placeholder="Any notes">
              </div>
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Add Loan</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Loans Table -->
      <div class="card">
        <div class="card-header">üí∞ Loans for <span id="loan-date-label">Today</span></div>
        <div id="loans-loading" class="loading" style="display: none;">
          <div class="spinner"></div>
          Loading...
        </div>
        <div id="loans-empty" class="empty-state" style="display: none;">
          <div class="empty-state-icon">üí∞</div>
          <p>No loans for this date.</p>
        </div>
        <div class="table-wrapper">
          <table id="loan-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Clear</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="loan-mobile-cards" class="mobile-cards" style="padding: 16px;"></div>
      </div>

      <div class="action-bar">
        <button id="save-loans" class="btn btn-success">üíæ Save Loans</button>
      </div>
    </section>

    <!-- Token Section -->
    <section id="token" class="page">
      <div class="section-header">
        <h2>Daily Token</h2>
      </div>

      <div class="date-row">
        <label>üìÖ Date:</label>
        <input type="date" id="token-date">
        <button id="load-token" class="btn btn-primary">Load</button>
      </div>

      <div class="card">
        <div class="card-header">üí∞ Token for <span id="token-date-label">Today</span></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label for="token-amount">Token Amount (Cash Received)</label>
              <input type="number" id="token-amount" placeholder="0.00" min="0" step="0.01" style="font-size: 1.5rem; font-weight: 700;">
            </div>
            <div class="form-group">
              <label for="token-notes">Notes</label>
              <input type="text" id="token-notes" placeholder="Any notes">
            </div>
          </div>
          <div class="action-bar">
            <button id="save-token" class="btn btn-success">üíæ Save Token</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">üìä Comparison</div>
        <div id="token-comparison" class="card-body">
          <div class="empty-state">
            <div class="empty-state-icon">üí∞</div>
            <p>Load a date to see comparison.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Reports Section -->
    <section id="reports" class="page">
      <div class="section-header">
        <h2>Daily Report</h2>
      </div>

      <div class="date-row">
        <label>üìÖ Date:</label>
        <input type="date" id="report-date">
        <button id="load-report" class="btn btn-primary">Generate Report</button>
      </div>

      <div id="report-loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        Generating...
      </div>

      <div id="report-results">
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <p>Select a date and generate report.</p>
        </div>
      </div>
    </section>
  </main>

  <button class="config-btn" id="config-btn" title="Settings">‚öôÔ∏è</button>

  <div class="modal-overlay" id="config-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Airtable Setup</h3>
        <button class="btn btn-icon btn-secondary" id="close-modal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="info-box">
          1. Go to <a href="https://airtable.com/create/tokens" target="_blank">Airtable Tokens</a><br>
          2. Create token with <code>data.records:read</code> & <code>data.records:write</code><br>
          3. Get Base ID from URL
        </div>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Personal Access Token</label>
            <input type="password" id="api-key" placeholder="pat...">
          </div>
          <div class="form-group full-width">
            <label>Base ID</label>
            <input type="text" id="base-id" placeholder="appXXXXX">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-config">Cancel</button>
        <button class="btn btn-primary" id="save-config">Save & Connect</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== CONFIG =====
    let CONFIG = {
      apiKey: localStorage.getItem('airtable_api_key') || '',
      baseId: localStorage.getItem('airtable_base_id') || ''
    };

    const TABLES = { customers: 'Customers', loans: 'Loans', token: 'Token' };
    const BANKS = ['SBI', 'HDFC', 'ICICI', 'Axis', 'Canara', 'PNB', 'BOB', 'Union', 'IDBI', 'Kotak', 'Yes Bank', 'IndusInd', 'Other'];

    // ===== STATE =====
    let customers = [];
    let loans = [];
    let currentToken = null;
    let isConnected = false;
    let currentEntryDate = '';
    let currentLoanDate = '';
    let currentTokenDate = '';
    let autoSaveTimeout = null;

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    // ===== UTILS =====
    function showToast(msg, type = 'info') {
      const t = $('#toast');
      t.textContent = msg;
      t.className = `toast ${type} show`;
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function formatCurrency(amt) {
      return '‚Çπ' + (amt || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    function formatDate(d) {
      if (!d) return '-';
      return new Date(d).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function getPreviousDate(dateStr) {
      const d = new Date(dateStr);
      d.setDate(d.getDate() - 1);
      return d.toISOString().split('T')[0];
    }

    function generateSerial(count, prefix = 'C') {
      return prefix + String(count + 1).padStart(3, '0');
    }

    function triggerAutoSave() {
      const s = $('#auto-save-status');
      if (s) s.innerHTML = '<span class="spinner" style="width:16px;height:16px;margin:0;"></span> Saving...';
      if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(async () => {
        await saveCustomerEntries(true);
        if (s) { s.innerHTML = '‚úÖ Saved'; setTimeout(() => s.innerHTML = '', 2000); }
      }, 1500);
    }

    // ===== API =====
    async function api(table, opts = {}) {
      if (!CONFIG.apiKey || !CONFIG.baseId) throw new Error('Not configured');
      let url;
      if (table.includes('/')) {
        const [t, id] = table.split('/');
        url = `https://api.airtable.com/v0/${CONFIG.baseId}/${encodeURIComponent(t)}/${id}`;
      } else {
        url = `https://api.airtable.com/v0/${CONFIG.baseId}/${encodeURIComponent(table)}`;
      }
      const res = await fetch(url + (opts.qs || ''), {
        method: opts.method || 'GET',
        headers: { 'Authorization': `Bearer ${CONFIG.apiKey}`, 'Content-Type': 'application/json' },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if (!res.ok) { console.error(await res.text()); throw new Error('API failed'); }
      if (opts.method === 'DELETE') return { deleted: true };
      return res.json();
    }

    async function testConnection() {
      try {
        await api(TABLES.customers, { qs: '?maxRecords=1' });
        isConnected = true;
        updateConnectionStatus();
        return true;
      } catch { isConnected = false; updateConnectionStatus(); return false; }
    }

    function updateConnectionStatus() {
      const s = $('#connection-status');
      s.className = `connection-status ${isConnected ? 'connected' : 'disconnected'}`;
      s.innerHTML = `<span class="connection-dot"></span><span>${isConnected ? 'Connected' : 'Not connected - Click ‚öôÔ∏è'}</span>`;
    }

    // ===== ENTRIES/CUSTOMERS =====
    async function loadEntriesForDate(dateStr) {
      if (!isConnected) return showToast('Configure Airtable first', 'error');
      currentEntryDate = dateStr;
      $('#entries-loading').style.display = 'flex';
      $('#entries-empty').style.display = 'none';
      $('#entries-date-label').textContent = formatDate(dateStr);

      try {
        const filter = encodeURIComponent(`{Date} = '${dateStr}'`);
        const data = await api(TABLES.customers, { qs: `?filterByFormula=${filter}&sort%5B0%5D%5Bfield%5D=Serial&sort%5B0%5D%5Bdirection%5D=asc` });
        customers = data.records;
        renderEntriesTable();
        $('#entry-count').textContent = customers.length;
      } catch { showToast('Failed to load', 'error'); }
      finally { $('#entries-loading').style.display = 'none'; }
    }

    function renderEntriesTable() {
      const tbody = $('#entries-table tbody');
      const mobile = $('#entries-mobile-cards');
      tbody.innerHTML = '';
      mobile.innerHTML = '';

      if (customers.length === 0) { $('#entries-empty').style.display = 'block'; return; }
      $('#entries-empty').style.display = 'none';

      customers.forEach((rec, i) => {
        const f = rec.fields;
        const toPay = f['Amount to Pay'] || 0;
        const paid = f['Amount Paid'] || 0;
        const balance = toPay - paid;
        const status = balance === 0 ? '‚úÖ' : 'üî¥';
        const cleared = f['Is Cleared'];

        const tr = document.createElement('tr');
        tr.dataset.recordId = rec.id;
        tr.dataset.index = i;
        tr.dataset.toPay = toPay;
        if (balance !== 0 && !cleared) tr.classList.add('has-balance');
        if (cleared) tr.classList.add('is-cleared');

        tr.innerHTML = `
          <td><span class="serial-badge">${f['Serial'] || ''}</span></td>
          <td><strong>${f['Customer Name'] || ''}</strong></td>
          <td class="amount-display">${formatCurrency(toPay)}</td>
          <td><input type="number" class="amt-paid" value="${paid}" min="0" step="0.01" style="width:90px;"></td>
          <td class="balance-cell"><strong>${formatCurrency(balance)}</strong></td>
          <td class="status-cell"><span class="status">${status}</span></td>
          <td><input type="checkbox" class="cleared-check" ${cleared ? 'checked' : ''}></td>
          <td><button class="delete-btn" data-id="${rec.id}">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);

        const card = document.createElement('div');
        card.className = `entry-card ${balance !== 0 && !cleared ? 'has-balance' : ''} ${cleared ? 'is-cleared' : ''}`;
        card.dataset.recordId = rec.id;
        card.dataset.index = i;
        card.dataset.toPay = toPay;
        card.innerHTML = `
          <div class="entry-card-header">
            <span><span class="serial-badge">${f['Serial'] || ''}</span> <strong>${f['Customer Name'] || ''}</strong></span>
            <button class="delete-btn" data-id="${rec.id}">üóëÔ∏è</button>
          </div>
          <div class="entry-card-grid">
            <div class="entry-card-field"><label>To Pay</label><div class="amount-display" style="padding:10px 0;">${formatCurrency(toPay)}</div></div>
            <div class="entry-card-field"><label>Paid</label><input type="number" class="amt-paid" value="${paid}" min="0" step="0.01"></div>
          </div>
          <div class="entry-card-footer">
            <span class="entry-card-balance ${balance === 0 ? 'zero' : 'positive'}">${formatCurrency(balance)} ${status}</span>
            <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" class="cleared-check" ${cleared ? 'checked' : ''}> Clear</label>
          </div>
        `;
        mobile.appendChild(card);
      });

      attachEntryEvents();
    }

    function attachEntryEvents() {
      $$('#entries .amt-paid').forEach(inp => inp.addEventListener('input', e => {
        updateBalance(e.target.closest('tr') || e.target.closest('.entry-card'));
        triggerAutoSave();
      }));

      $$('#entries .cleared-check').forEach(chk => chk.addEventListener('change', e => {
        const c = e.target.closest('tr') || e.target.closest('.entry-card');
        const toPay = parseFloat(c.dataset.toPay) || 0;
        if (e.target.checked) {
          c.querySelector('.amt-paid').value = toPay;
          c.classList.add('is-cleared');
          c.classList.remove('has-balance');
        } else { c.classList.remove('is-cleared'); }
        updateBalance(c);
        triggerAutoSave();
      }));

      $$('#entries .delete-btn').forEach(btn => btn.onclick = async function() {
        const id = this.dataset.id;
        if (id && confirm('Delete?')) {
          try { await api(TABLES.customers + '/' + id, { method: 'DELETE' }); customers = customers.filter(c => c.id !== id); renderEntriesTable(); $('#entry-count').textContent = customers.length; showToast('Deleted', 'success'); }
          catch { showToast('Failed', 'error'); }
        }
      });
    }

    function updateBalance(c) {
      const toPay = parseFloat(c.dataset.toPay) || 0;
      const paid = parseFloat(c.querySelector('.amt-paid').value) || 0;
      const balance = toPay - paid;
      const cleared = c.querySelector('.cleared-check').checked;

      const bc = c.querySelector('.balance-cell');
      const sc = c.querySelector('.status-cell');
      if (bc) bc.innerHTML = `<strong>${formatCurrency(balance)}</strong>`;
      if (sc) sc.innerHTML = `<span class="status">${balance === 0 ? '‚úÖ' : 'üî¥'}</span>`;

      const mb = c.querySelector('.entry-card-balance');
      if (mb) { mb.textContent = `${formatCurrency(balance)} ${balance === 0 ? '‚úÖ' : 'üî¥'}`; mb.className = `entry-card-balance ${balance === 0 ? 'zero' : 'positive'}`; }

      if (!cleared) { balance === 0 ? c.classList.remove('has-balance') : c.classList.add('has-balance'); }
    }

    async function saveCustomerEntries(silent = false) {
      if (!currentEntryDate) return;
      const rows = $$('#entries-table tbody tr');
      if (rows.length === 0) return;

      const updates = [];
      rows.forEach(tr => {
        const id = tr.dataset.recordId;
        if (!id) return;
        updates.push({ id, fields: { 'Amount Paid': parseFloat(tr.querySelector('.amt-paid').value) || 0, 'Is Cleared': tr.querySelector('.cleared-check').checked } });
      });

      try { if (updates.length) await api(TABLES.customers, { method: 'PATCH', body: { records: updates } }); if (!silent) showToast('Saved!', 'success'); }
      catch { if (!silent) showToast('Failed', 'error'); }
    }

    async function addCustomer(fd) {
      const dateStr = currentEntryDate || getTodayDate();
      const serial = generateSerial(customers.length);
      const fields = { 'Date': dateStr, 'Serial': serial, 'Customer Name': fd.get('name'), 'Amount to Pay': parseFloat(fd.get('amountToPay')) || 0, 'Amount Paid': 0, 'Is Cleared': false };
      const ac = fd.get('agentCode'); if (ac) fields['Agent Code'] = ac;
      const bk = fd.get('bank'); if (bk) fields['Bank'] = bk;

      try { const res = await api(TABLES.customers, { method: 'POST', body: { records: [{ fields }] } }); customers.push(res.records[0]); renderEntriesTable(); $('#entry-count').textContent = customers.length; showToast(`${serial} added`, 'success'); }
      catch { showToast('Failed', 'error'); }
    }

    // ===== LOANS =====
    async function loadLoansForDate(dateStr) {
      if (!isConnected) return showToast('Configure Airtable first', 'error');
      currentLoanDate = dateStr;
      $('#loans-loading').style.display = 'flex';
      $('#loans-empty').style.display = 'none';
      $('#loan-date-label').textContent = formatDate(dateStr);

      try {
        const filter = encodeURIComponent(`{Date} = '${dateStr}'`);
        const data = await api(TABLES.loans, { qs: `?filterByFormula=${filter}` });
        loans = data.records;
        renderLoanTable();
      } catch { showToast('Failed', 'error'); }
      finally { $('#loans-loading').style.display = 'none'; }
    }

    function renderLoanTable() {
      const tbody = $('#loan-table tbody');
      const mobile = $('#loan-mobile-cards');
      tbody.innerHTML = '';
      mobile.innerHTML = '';

      if (loans.length === 0) { $('#loans-empty').style.display = 'block'; return; }
      $('#loans-empty').style.display = 'none';

      loans.forEach((rec, i) => {
        const f = rec.fields;
        const type = f['Type'] || 'Given';
        const amount = f['Amount'] || 0;
        const paid = f['Paid'] || 0;
        const balance = amount - paid;
        const status = balance === 0 ? '‚úÖ' : 'üî¥';
        const cleared = f['Is Cleared'];
        const typeClass = type === 'Given' ? 'given' : 'received';

        const tr = document.createElement('tr');
        tr.dataset.recordId = rec.id;
        tr.dataset.index = i;
        tr.dataset.amount = amount;
        if (balance !== 0 && !cleared) tr.classList.add('has-balance');
        if (cleared) tr.classList.add('is-cleared');

        tr.innerHTML = `
          <td><span class="loan-type-badge ${typeClass}">${type}</span></td>
          <td><strong>${f['Customer Name'] || ''}</strong></td>
          <td class="amount-display">${formatCurrency(amount)}</td>
          <td><input type="number" class="loan-paid" value="${paid}" min="0" step="0.01" style="width:90px;"></td>
          <td class="balance-cell"><strong>${formatCurrency(balance)}</strong></td>
          <td class="status-cell"><span class="status">${status}</span></td>
          <td><input type="checkbox" class="loan-cleared" ${cleared ? 'checked' : ''}></td>
          <td><button class="delete-btn" data-id="${rec.id}">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);

        const card = document.createElement('div');
        card.className = `entry-card ${balance !== 0 && !cleared ? 'has-balance' : ''} ${cleared ? 'is-cleared' : ''}`;
        card.dataset.recordId = rec.id;
        card.dataset.index = i;
        card.dataset.amount = amount;
        card.innerHTML = `
          <div class="entry-card-header">
            <span><span class="loan-type-badge ${typeClass}">${type}</span> <strong>${f['Customer Name'] || ''}</strong></span>
            <button class="delete-btn" data-id="${rec.id}">üóëÔ∏è</button>
          </div>
          <div class="entry-card-grid">
            <div class="entry-card-field"><label>Amount</label><div class="amount-display" style="padding:10px 0;">${formatCurrency(amount)}</div></div>
            <div class="entry-card-field"><label>Paid</label><input type="number" class="loan-paid" value="${paid}" min="0" step="0.01"></div>
          </div>
          <div class="entry-card-footer">
            <span class="entry-card-balance ${balance === 0 ? 'zero' : 'positive'}">${formatCurrency(balance)} ${status}</span>
            <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" class="loan-cleared" ${cleared ? 'checked' : ''}> Clear</label>
          </div>
        `;
        mobile.appendChild(card);
      });

      attachLoanEvents();
    }

    function attachLoanEvents() {
      $$('#loan .loan-paid').forEach(inp => inp.addEventListener('input', e => updateLoanBalance(e.target.closest('tr') || e.target.closest('.entry-card'))));

      $$('#loan .loan-cleared').forEach(chk => chk.addEventListener('change', e => {
        const c = e.target.closest('tr') || e.target.closest('.entry-card');
        const amt = parseFloat(c.dataset.amount) || 0;
        if (e.target.checked) { c.querySelector('.loan-paid').value = amt; c.classList.add('is-cleared'); c.classList.remove('has-balance'); }
        else { c.classList.remove('is-cleared'); }
        updateLoanBalance(c);
      }));

      $$('#loan .delete-btn').forEach(btn => btn.onclick = async function() {
        const id = this.dataset.id;
        if (id && confirm('Delete?')) {
          try { await api(TABLES.loans + '/' + id, { method: 'DELETE' }); loans = loans.filter(l => l.id !== id); renderLoanTable(); showToast('Deleted', 'success'); }
          catch { showToast('Failed', 'error'); }
        }
      });
    }

    function updateLoanBalance(c) {
      const amt = parseFloat(c.dataset.amount) || 0;
      const paid = parseFloat(c.querySelector('.loan-paid').value) || 0;
      const balance = amt - paid;
      const cleared = c.querySelector('.loan-cleared').checked;

      const bc = c.querySelector('.balance-cell');
      const sc = c.querySelector('.status-cell');
      if (bc) bc.innerHTML = `<strong>${formatCurrency(balance)}</strong>`;
      if (sc) sc.innerHTML = `<span class="status">${balance === 0 ? '‚úÖ' : 'üî¥'}</span>`;

      const mb = c.querySelector('.entry-card-balance');
      if (mb) { mb.textContent = `${formatCurrency(balance)} ${balance === 0 ? '‚úÖ' : 'üî¥'}`; mb.className = `entry-card-balance ${balance === 0 ? 'zero' : 'positive'}`; }

      if (!cleared) { balance === 0 ? c.classList.remove('has-balance') : c.classList.add('has-balance'); }
    }

    async function addLoan(fd) {
      const dateStr = currentLoanDate || getTodayDate();
      const fields = { 'Date': dateStr, 'Type': fd.get('type'), 'Customer Name': fd.get('name'), 'Amount': parseFloat(fd.get('amount')) || 0, 'Paid': 0, 'Is Cleared': false };
      const notes = fd.get('notes'); if (notes) fields['Notes'] = notes;

      try { const res = await api(TABLES.loans, { method: 'POST', body: { records: [{ fields }] } }); loans.push(res.records[0]); renderLoanTable(); showToast('Loan added', 'success'); }
      catch { showToast('Failed', 'error'); }
    }

    async function saveLoans() {
      const rows = $$('#loan-table tbody tr');
      if (rows.length === 0) return;

      const updates = [];
      rows.forEach(tr => {
        const id = tr.dataset.recordId;
        if (!id) return;
        updates.push({ id, fields: { 'Paid': parseFloat(tr.querySelector('.loan-paid').value) || 0, 'Is Cleared': tr.querySelector('.loan-cleared').checked } });
      });

      try { if (updates.length) await api(TABLES.loans, { method: 'PATCH', body: { records: updates } }); showToast('Saved!', 'success'); }
      catch { showToast('Failed', 'error'); }
    }

    // ===== TOKEN =====
    async function loadTokenForDate(dateStr) {
      if (!isConnected) return showToast('Configure first', 'error');
      currentTokenDate = dateStr;
      $('#token-date-label').textContent = formatDate(dateStr);

      try {
        const filter = encodeURIComponent(`{Date} = '${dateStr}'`);
        const tData = await api(TABLES.token, { qs: `?filterByFormula=${filter}` });
        currentToken = tData.records[0] || null;
        $('#token-amount').value = currentToken?.fields['Amount'] || '';
        $('#token-notes').value = currentToken?.fields['Notes'] || '';

        const cData = await api(TABLES.customers, { qs: `?filterByFormula=${filter}` });
        let totalPaid = 0;
        cData.records.forEach(r => totalPaid += (r.fields['Amount Paid'] || 0));

        const tokenAmt = currentToken?.fields['Amount'] || 0;
        const diff = tokenAmt - totalPaid;

        $('#token-comparison').innerHTML = `
          <div class="report-grid">
            <div class="report-card"><div class="report-card-label">üí∞ Token</div><div class="report-card-value">${formatCurrency(tokenAmt)}</div></div>
            <div class="report-card"><div class="report-card-label">üìù Total Paid</div><div class="report-card-value">${formatCurrency(totalPaid)}</div></div>
            <div class="report-card"><div class="report-card-label">üìä Difference</div><div class="report-card-value ${diff < 0 ? 'positive' : ''}">${formatCurrency(diff)}</div>
              <div style="font-size:0.75rem;margin-top:4px;${diff === 0 ? 'color:var(--success)' : ''}">${diff === 0 ? '‚úÖ Matched' : diff > 0 ? 'Extra cash' : 'Less cash'}</div>
            </div>
          </div>
        `;
      } catch { showToast('Failed', 'error'); }
    }

    async function saveToken() {
      const dateStr = currentTokenDate || getTodayDate();
      const fields = { 'Date': dateStr, 'Amount': parseFloat($('#token-amount').value) || 0, 'Notes': $('#token-notes').value || '' };

      try {
        if (currentToken) await api(TABLES.token, { method: 'PATCH', body: { records: [{ id: currentToken.id, fields }] } });
        else await api(TABLES.token, { method: 'POST', body: { records: [{ fields }] } });
        showToast('Saved!', 'success');
        await loadTokenForDate(dateStr);
      } catch { showToast('Failed', 'error'); }
    }

    // ===== REPORTS =====
    async function loadReportForDate(dateStr) {
      if (!isConnected) return showToast('Configure first', 'error');
      $('#report-loading').style.display = 'flex';

      try {
        const filter = encodeURIComponent(`{Date} = '${dateStr}'`);
        const prevDate = getPreviousDate(dateStr);
        const prevFilter = encodeURIComponent(`{Date} = '${prevDate}'`);

        // Today's data
        const [cData, lData, tData] = await Promise.all([
          api(TABLES.customers, { qs: `?filterByFormula=${filter}` }),
          api(TABLES.loans, { qs: `?filterByFormula=${filter}` }),
          api(TABLES.token, { qs: `?filterByFormula=${filter}` })
        ]);

        // Previous day's data for opening balance
        const [prevCData, prevLData] = await Promise.all([
          api(TABLES.customers, { qs: `?filterByFormula=${prevFilter}` }),
          api(TABLES.loans, { qs: `?filterByFormula=${prevFilter}` })
        ]);

        // Calculate previous day closing (= today's opening)
        let prevToPay = 0, prevPaid = 0, prevLoanGiven = 0, prevLoanGivenPaid = 0, prevLoanReceived = 0, prevLoanReceivedPaid = 0;
        prevCData.records.forEach(r => { prevToPay += (r.fields['Amount to Pay'] || 0); prevPaid += (r.fields['Amount Paid'] || 0); });
        prevLData.records.forEach(r => {
          const t = r.fields['Type'] || 'Given';
          const amt = r.fields['Amount'] || 0;
          const pd = r.fields['Paid'] || 0;
          if (t === 'Given') { prevLoanGiven += amt; prevLoanGivenPaid += pd; }
          else { prevLoanReceived += amt; prevLoanReceivedPaid += pd; }
        });
        const prevCustomerBalance = prevToPay - prevPaid;
        const prevLoanGivenBalance = prevLoanGiven - prevLoanGivenPaid;
        const prevLoanReceivedBalance = prevLoanReceived - prevLoanReceivedPaid;
        const openingBalance = prevCustomerBalance + prevLoanGivenBalance - prevLoanReceivedBalance;

        // Today's calculations
        let totalToPay = 0, totalPaid = 0, loanGiven = 0, loanGivenPaid = 0, loanReceived = 0, loanReceivedPaid = 0;
        cData.records.forEach(r => { totalToPay += (r.fields['Amount to Pay'] || 0); totalPaid += (r.fields['Amount Paid'] || 0); });
        lData.records.forEach(r => {
          const t = r.fields['Type'] || 'Given';
          const amt = r.fields['Amount'] || 0;
          const pd = r.fields['Paid'] || 0;
          if (t === 'Given') { loanGiven += amt; loanGivenPaid += pd; }
          else { loanReceived += amt; loanReceivedPaid += pd; }
        });

        const tokenAmt = tData.records[0]?.fields['Amount'] || 0;
        const customerBalance = totalToPay - totalPaid;
        const loanGivenBalance = loanGiven - loanGivenPaid;
        const loanReceivedBalance = loanReceived - loanReceivedPaid;
        const closingBalance = customerBalance + loanGivenBalance - loanReceivedBalance;

        $('#report-results').innerHTML = `
          <div class="report-grid">
            <div class="report-card highlight">
              <div class="report-card-label">üìÖ Opening Balance</div>
              <div class="report-card-value">${formatCurrency(openingBalance)}</div>
              <div style="font-size:0.7rem;margin-top:4px;opacity:0.8;">From ${formatDate(prevDate)}</div>
            </div>
            <div class="report-card">
              <div class="report-card-label">üìÖ Date</div>
              <div class="report-card-value" style="font-size:1.1rem;">${formatDate(dateStr)}</div>
            </div>
            <div class="report-card">
              <div class="report-card-label">üë• Customers</div>
              <div class="report-card-value">${cData.records.length}</div>
            </div>

            <div class="report-divider"></div>

            <div class="report-card">
              <div class="report-card-label">Total to Pay</div>
              <div class="report-card-value">${formatCurrency(totalToPay)}</div>
            </div>
            <div class="report-card">
              <div class="report-card-label">Total Paid</div>
              <div class="report-card-value">${formatCurrency(totalPaid)}</div>
            </div>
            <div class="report-card">
              <div class="report-card-label">Customer Balance</div>
              <div class="report-card-value ${customerBalance > 0 ? 'positive' : ''}">${formatCurrency(customerBalance)}</div>
            </div>

            <div class="report-divider"></div>

            <div class="report-card">
              <div class="report-card-label">üí∏ Loan Given (They owe)</div>
              <div class="report-card-value">${formatCurrency(loanGiven)}</div>
              <div style="font-size:0.75rem;color:var(--text-secondary);">Paid back: ${formatCurrency(loanGivenPaid)}</div>
            </div>
            <div class="report-card">
              <div class="report-card-label">üì• Loan Received (We owe)</div>
              <div class="report-card-value">${formatCurrency(loanReceived)}</div>
              <div style="font-size:0.75rem;color:var(--text-secondary);">Paid: ${formatCurrency(loanReceivedPaid)}</div>
            </div>
            <div class="report-card">
              <div class="report-card-label">üí∞ Token</div>
              <div class="report-card-value">${formatCurrency(tokenAmt)}</div>
            </div>

            <div class="report-divider"></div>

            <div class="report-card">
              <div class="report-card-label">Loan Given Balance</div>
              <div class="report-card-value ${loanGivenBalance > 0 ? 'negative' : ''}">${formatCurrency(loanGivenBalance)}</div>
              <div style="font-size:0.7rem;color:var(--text-secondary);">They still owe us</div>
            </div>
            <div class="report-card">
              <div class="report-card-label">Loan Received Balance</div>
              <div class="report-card-value ${loanReceivedBalance > 0 ? 'positive' : ''}">${formatCurrency(loanReceivedBalance)}</div>
              <div style="font-size:0.7rem;color:var(--text-secondary);">We still owe them</div>
            </div>

            <div class="report-divider"></div>

            <div class="report-card success">
              <div class="report-card-label">üìä Closing Balance</div>
              <div class="report-card-value">${formatCurrency(closingBalance)}</div>
              <div style="font-size:0.7rem;margin-top:4px;opacity:0.8;">Tomorrow's Opening</div>
            </div>
          </div>
        `;
      } catch (e) { console.error(e); showToast('Failed', 'error'); }
      finally { $('#report-loading').style.display = 'none'; }
    }

    // ===== NAV =====
    function initNav() {
      $$('nav button').forEach(btn => btn.addEventListener('click', () => {
        const page = btn.dataset.page;
        $$('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        $$('.page').forEach(p => p.classList.remove('active'));
        $(`#${page}`).classList.add('active');
      }));
    }

    // ===== CONFIG MODAL =====
    function initConfigModal() {
      $('#config-btn').onclick = () => { $('#api-key').value = CONFIG.apiKey; $('#base-id').value = CONFIG.baseId; $('#config-modal').classList.add('active'); };
      $('#close-modal').onclick = () => $('#config-modal').classList.remove('active');
      $('#cancel-config').onclick = () => $('#config-modal').classList.remove('active');
      $('#save-config').onclick = async () => {
        CONFIG.apiKey = $('#api-key').value.trim();
        CONFIG.baseId = $('#base-id').value.trim();
        localStorage.setItem('airtable_api_key', CONFIG.apiKey);
        localStorage.setItem('airtable_base_id', CONFIG.baseId);
        $('#config-modal').classList.remove('active');
        showToast('Connecting...', 'info');
        if (await testConnection()) { showToast('Connected!', 'success'); await loadEntriesForDate(getTodayDate()); }
        else showToast('Failed', 'error');
      };
      $('#config-modal').onclick = e => { if (e.target === $('#config-modal')) $('#config-modal').classList.remove('active'); };
    }

    // ===== INIT =====
    function initBanks() {
      const s = $('#bank');
      BANKS.forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; s.appendChild(o); });
    }

    function initEvents() {
      $('#customer-form').onsubmit = async e => { e.preventDefault(); if (!currentEntryDate) currentEntryDate = $('#entry-date').value || getTodayDate(); await addCustomer(new FormData(e.target)); e.target.reset(); };
      $('#loan-form').onsubmit = async e => { e.preventDefault(); if (!currentLoanDate) currentLoanDate = $('#loan-date').value || getTodayDate(); await addLoan(new FormData(e.target)); e.target.reset(); };

      $('#load-entries').onclick = () => { const d = $('#entry-date').value; if (d) loadEntriesForDate(d); else showToast('Select date', 'error'); };
      $('#load-loans').onclick = () => { const d = $('#loan-date').value; if (d) loadLoansForDate(d); else showToast('Select date', 'error'); };
      $('#load-token').onclick = () => { const d = $('#token-date').value; if (d) loadTokenForDate(d); else showToast('Select date', 'error'); };
      $('#load-report').onclick = () => { const d = $('#report-date').value; if (d) loadReportForDate(d); else showToast('Select date', 'error'); };

      $('#save-entries').onclick = () => saveCustomerEntries(false);
      $('#save-loans').onclick = saveLoans;
      $('#save-token').onclick = saveToken;

      const today = getTodayDate();
      $('#entry-date').value = today;
      $('#loan-date').value = today;
      $('#token-date').value = today;
      $('#report-date').value = today;
    }

    async function init() {
      initNav();
      initConfigModal();
      initBanks();
      initEvents();
      if (CONFIG.apiKey && CONFIG.baseId) { if (await testConnection()) await loadEntriesForDate(getTodayDate()); }
      else updateConnectionStatus();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
